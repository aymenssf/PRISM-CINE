{% extends "base.html" %}

{% block content %}
<div class="flex flex-col gap-16 pb-20">

    <!-- ══════════════════════════════════════════════════════════════════
         HERO SECTION: Split Panel (Identity vs Metrics)
         ══════════════════════════════════════════════════════════════════ -->
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-[300px]">

        <!-- LEFT: Identity / Welcome -->
        <div
            class="lg:col-span-8 relative group overflow-hidden rounded-3xl bg-neutral-900 border border-neutral-800 p-10 flex flex-col justify-between">
            <div
                class="absolute inset-0 bg-[radial-gradient(circle_at_top_right,rgba(255,255,255,0.05),transparent_40%)]">
            </div>

            <!-- Decorative elements -->
            <div class="flex justify-between items-start opacity-50">
                <div class="flex gap-2">
                    <div class="w-1 h-1 bg-white rounded-full"></div>
                    <div class="w-1 h-1 bg-white rounded-full"></div>
                    <div class="w-1 h-1 bg-white rounded-full"></div>
                </div>
                <div class="font-mono text-[10px]">OBSERVER_ID: 9942-ALPHA</div>
            </div>

            <div class="relative z-10 mt-8">
                <h1 class="text-5xl md:text-7xl font-bold tracking-tighter text-white mb-4">
                    THE PRISM.<br>
                    <span class="text-neutral-600">ECHOES OF CINEMA.</span>
                </h1>
                <p class="max-w-md text-neutral-400 font-mono text-sm leading-relaxed">
                    Prism isn't just a database.
                    Dive into the stream and let the algorithm find what moves you.
                </p>
            </div>

            <div class="relative z-10 pt-8 flex items-center gap-4">
                <button onclick="document.getElementById('rateFormSection').scrollIntoView({behavior: 'smooth'})"
                    class="px-6 py-3 bg-white text-black font-semibold rounded-full hover:bg-neutral-200 transition-colors text-sm">
                    Contribute Data
                </button>
                <div class="h-px w-20 bg-neutral-800"></div>
                <div class="text-[10px] font-mono text-neutral-500 uppercase tracking-widest">CONNECTION_ESTABLISHED
                </div>
            </div>
        </div>

        <!-- RIGHT: Live Metrics (Faux Real-time) -->
        <div class="lg:col-span-4 grid grid-rows-3 gap-4">
            <!-- Stat 1 -->
            <div
                class="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 flex items-center justify-between relative overflow-hidden group">
                <div
                    class="absolute inset-0 bg-neutral-800/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000">
                </div>
                <div>
                    <div class="text-[10px] uppercase tracking-widest text-neutral-500 mb-1">Total Users</div>
                    <div class="font-mono text-2xl text-emerald-400">{{ stats.total_users }}</div>
                </div>
                <svg class="w-10 h-10 text-emerald-500/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>

            <!-- Stat 2 -->
            <div
                class="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 flex items-center justify-between relative overflow-hidden group">
                <div>
                    <div class="text-[10px] uppercase tracking-widest text-neutral-500 mb-1">Total Ratings</div>
                    <div class="font-mono text-2xl text-violet-400">{{ stats.total_ratings }}</div>
                </div>
                <svg class="w-10 h-10 text-violet-500/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>

            <!-- Stat 3 -->
            <div class="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 flex items-center justify-between">
                <div>
                    <div class="text-[10px] uppercase tracking-widest text-neutral-500 mb-1">Matrix Density</div>
                    <div class="font-mono text-2xl text-white">{{ "%.1f"|format((stats.total_ratings / (movies|length *
                        (stats.total_users + 1))) * 100) }}%</div>
                </div>
                <div class="flex gap-1">
                    <span class="w-1 h-6 bg-neutral-700 rounded-sm"></span>
                    <span class="w-1 h-4 bg-neutral-700 rounded-sm"></span>
                    <span class="w-1 h-8 bg-white rounded-sm"></span>
                    <span class="w-1 h-5 bg-neutral-700 rounded-sm"></span>
                </div>
            </div>
        </div>
    </section>

    <!-- ══════════════════════════════════════════════════════════════════
         DATA PREP SECTION (Forms)
         ══════════════════════════════════════════════════════════════════ -->
    <section id="rateFormSection" class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Manual Rating -->
        <div class="p-8 border-l border-neutral-800">
            <h3 class="text-xl font-bold tracking-tight mb-6">Signal Input</h3>
            <form id="rateForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-neutral-500 mb-2">Internal User
                            ID</label>
                        <input type="text" name="user_id" placeholder="aymen" required
                            class="w-full bg-neutral-900 border border-neutral-800 rounded-lg px-4 py-3 text-sm focus:border-white focus:outline-none transition-colors font-mono">
                    </div>
                    <div>
                        <label class="block text-[10px] uppercase tracking-wider text-neutral-500 mb-2">Rating</label>
                        <input type="number" name="rating" min="1" max="5" step="0.5" value="5"
                            class="w-full bg-neutral-900 border border-neutral-800 rounded-lg px-4 py-3 text-sm focus:border-white focus:outline-none transition-colors font-mono text-center">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase tracking-wider text-neutral-500 mb-2">Subject</label>
                    <select name="movie_id"
                        class="w-full bg-neutral-900 border border-neutral-800 rounded-lg px-4 py-3 text-sm focus:border-white focus:outline-none transition-colors appearance-none font-mono">
                        {% for movie in movies %}
                        <option value="{{ movie.movie_id }}">{{ movie.title }} ({{ movie.genre }})</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit"
                    class="w-full py-3 bg-neutral-100 text-neutral-950 font-bold rounded-lg hover:bg-white transition-colors text-xs uppercase tracking-widest">
                    Inject Signal
                </button>
            </form>
            <div id="rateResult" class="mt-4 h-6 text-xs font-mono"></div>
        </div>

        <!-- Recommendation Request -->
        <div class="p-8 border-l border-neutral-800">
            <h3 class="text-xl font-bold tracking-tight mb-6">Query The Prism</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase tracking-wider text-neutral-500 mb-2">Target Subject
                        ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="recUserId" placeholder="Target User ID"
                            class="flex-1 bg-neutral-900 border border-neutral-800 rounded-lg px-4 py-3 text-sm focus:border-white focus:outline-none transition-colors font-mono">
                        <button onclick="fetchRecs()"
                            class="px-6 py-3 border border-neutral-700 rounded-lg hover:bg-neutral-800 transition-colors text-xs font-bold uppercase tracking-widest">
                            Query
                        </button>
                    </div>
                </div>
                <p class="text-xs text-neutral-500 leading-relaxed">
                    Triggers the Prism Engine. SVD factorization for 'Match' candidates and Epsilon-Greedy exploration
                    for 'Discovery' candidates.
                </p>
            </div>
        </div>
    </section>

    <!-- ══════════════════════════════════════════════════════════════════
         RECOMMENDATION STREAM
         ══════════════════════════════════════════════════════════════════ -->
    <section>
        <div class="flex items-end justify-between mb-8 border-b border-neutral-800 pb-4">
            <h2 class="text-3xl font-bold tracking-tight">Live Feed</h2>
            <div class="flex gap-4 text-[10px] uppercase tracking-widest font-mono text-neutral-500">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-neutral-700"></div> Match
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full border border-violet-500"></div> Discovery
                </div>
            </div>
        </div>

        <div id="recList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 min-h-[200px]">
            <!-- Populated via JS -->
            <div class="col-span-full flex flex-col items-center justify-center text-neutral-600 space-y-4 py-12">
                <div class="w-12 h-12 border-2 border-neutral-800 border-t-neutral-600 rounded-full animate-spin"></div>
                <div class="text-xs font-mono uppercase tracking-widest">Awaiting your query...</div>
            </div>
        </div>
    </section>

    <!-- ══════════════════════════════════════════════════════════════════
         FULL CATALOG
         ══════════════════════════════════════════════════════════════════ -->
    <section>
        <div class="mb-8 pt-10">
            <h2 class="text-xs font-mono uppercase tracking-widest text-neutral-500 mb-4">The Archives</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 auto-rows-[340px] gap-4">
            {% for movie in movies %}
            <div class="group relative bg-neutral-900 border border-neutral-800 rounded-xl overflow-hidden transition-all duration-500 hover:border-neutral-600
                 {% if current_boost and current_boost in movie.genre %}
                    ring-1 ring-emerald-500/50 shadow-[0_0_30px_rgba(16,185,129,0.1)]
                 {% endif %}
             ">
                <!-- Image Area -->
                <div class="h-[65%] w-full relative overflow-hidden bg-neutral-950">
                    <img src="{{ movie.poster_url }}"
                        onerror="this.src='https://placehold.co/600x900/1a1a1a/666?text=Error'"
                        class="w-full h-full object-cover opacity-60 mix-blend-overlay group-hover:opacity-100 group-hover:mix-blend-normal transition-all duration-700 grayscale group-hover:grayscale-0"
                        alt="{{ movie.title }}">

                    <!-- Gradient Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-neutral-900 via-transparent to-transparent">
                    </div>

                    <!-- Genre Badge -->
                    <div class="absolute top-4 left-4">
                        <span
                            class="px-2 py-1 text-[9px] font-bold tracking-widest uppercase border border-white/10 bg-black/50 backdrop-blur-sm rounded text-neutral-300">
                            {{ movie.genre }}
                        </span>
                    </div>
                </div>

                <!-- Content Area -->
                <div class="p-6 h-[35%] flex flex-col justify-between relative">
                    <!-- Title -->
                    <div>
                        <h3
                            class="font-bold text-lg leading-tight text-neutral-200 group-hover:text-white transition-colors truncate">
                            {{ movie.title }}
                        </h3>
                        <p class="text-[10px] font-mono text-neutral-500 mt-1">Ref: {{ movie.movie_id }}</p>
                    </div>

                    <!-- Action -->
                    <div class="flex items-center justify-between mt-2">
                        <button onclick="quickRate('{{ movie.movie_id }}', '{{ movie.title }}')"
                            class="px-3 py-1.5 text-[10px] font-bold uppercase tracking-wider border border-neutral-700 hover:bg-white hover:text-black hover:border-white transition-all rounded">
                            Rate
                        </button>

                        {% if current_boost and current_boost in movie.genre %}
                        <span
                            class="flex items-center gap-1.5 text-[9px] font-bold text-emerald-500 tracking-widest uppercase animate-pulse">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                            Trending
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

</div>

<script>
    // Constants for SVG rings
    const RADIUS = 16;
    const CIRCUMFERENCE = 2 * Math.PI * RADIUS;

    function getScoreRing(score) {
        // Score is 1-5.
        const normalized = (score / 5) * 100;
        const offset = CIRCUMFERENCE - (normalized / 100) * CIRCUMFERENCE;

        let colorClass = "text-neutral-500";
        if (score >= 4) colorClass = "text-emerald-400";
        else if (score >= 3) colorClass = "text-amber-400";
        else colorClass = "text-red-400";

        return `
        <div class="relative w-10 h-10 flex items-center justify-center">
            <svg class="w-full h-full transform -rotate-90">
                <circle cx="20" cy="20" r="${RADIUS}" stroke="currentColor" stroke-width="2" fill="transparent" class="text-neutral-800" />
                <circle cx="20" cy="20" r="${RADIUS}" stroke="currentColor" stroke-width="2" fill="transparent"
                    stroke-dasharray="${CIRCUMFERENCE}"
                    stroke-dashoffset="${offset}"
                    class="${colorClass} transition-all duration-1000 ease-out" />
            </svg>
            <span class="absolute text-[9px] font-bold font-mono text-white">${score.toFixed(1)}</span>
        </div>
        `;
    }

    /* -- Rating form submission -- */
    document.getElementById('rateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const payload = Object.fromEntries(fd);
        payload.rating = parseFloat(payload.rating);

        const resultEl = document.getElementById('rateResult');
        resultEl.textContent = '>> TRANSMITTING SIGNAL...';
        resultEl.className = 'mt-4 h-6 text-xs font-mono text-amber-500 animate-pulse';

        try {
            const res = await fetch('/api/rate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (data.status === 'ok') {
                resultEl.innerHTML = `<span class="text-emerald-500">>> SIGNAL RECEIVED [ID:${data.movie_id} :: R:${data.rating}]</span>`;
                resultEl.className = 'mt-4 h-6 text-xs font-mono';
                setTimeout(() => { resultEl.textContent = ''; }, 3000);
            } else {
                resultEl.textContent = `>> ERROR: ${data.error}`;
                resultEl.className = 'mt-4 h-6 text-xs font-mono text-red-500';
            }
        } catch (err) {
            resultEl.textContent = '>> CONNECTION FAILURE';
            resultEl.className = 'mt-4 h-6 text-xs font-mono text-red-500';
        }
    });

    /* -- Quick rate -- */
    function quickRate(movieId, title) {
        const userId = prompt(`User ID for "${title}" :`);
        if (!userId) return;
        const rating = prompt(`Rating for "${title}" (1-5) :`, "5");
        if (!rating) return;

        fetch('/api/rate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, movie_id: movieId, rating: parseFloat(rating) }),
        }).then(r => r.json()).then(data => {
            if (data.status === 'ok') alert("Rating Recorded.");
        });
    }

    /* -- Fetch Recs -- */
    async function fetchRecs() {
        const userId = document.getElementById('recUserId').value.trim();
        if (!userId) return;

        const list = document.getElementById('recList');
        // Loading State
        list.innerHTML = `
            <div class="col-span-full flex flex-col items-center justify-center py-12">
                 <div class="w-12 h-12 border-2 border-dashed border-emerald-500 rounded-full animate-spin"></div>
                 <div class="mt-4 text-xs font-mono text-emerald-500 uppercase tracking-widest">Processing Matrix...</div>
            </div>
        `;

        try {
            const res = await fetch(`/api/recommend/${encodeURIComponent(userId)}?n=8`);
            const data = await res.json();

            if (!data.recommendations || data.recommendations.length === 0) {
                list.innerHTML = '<div class="col-span-full text-center text-neutral-500 text-xs font-mono">NO DATA FOUND FOR USER</div>';
                return;
            }

            const currentBoost = '{{ current_boost or "" }}';
            const posters = {{ posters|tojson|safe }};  // Dict {movie_id: poster_url}

            list.innerHTML = data.recommendations.map(r => {
                const isDiscovery = r.strategy === 'DISCOVERY';
                // Styles
                let cardClass = "bg-neutral-900 border-neutral-800 hover:border-neutral-500";
                let badgeClass = "bg-neutral-800 text-neutral-400 border-neutral-700";

                if (isDiscovery) {
                    cardClass = "bg-violet-950/10 border-violet-500/30 hover:border-violet-400 hover:shadow-[0_0_30px_rgba(139,92,246,0.15)]";
                    badgeClass = "bg-violet-500/10 text-violet-300 border-violet-500/30";
                } else if (currentBoost && r.genre.includes(currentBoost)) {
                    cardClass = "bg-emerald-950/10 border-emerald-500/50 hover:border-emerald-400 hover:shadow-[0_0_30px_rgba(16,185,129,0.15)]";
                    badgeClass = "bg-emerald-500/10 text-emerald-300 border-emerald-500/30";
                }

                // Récupérer poster URL depuis le dict, sinon placeholder
                const posterUrl = posters[r.movie_id] || `https://placehold.co/600x900/1a1a1a/666?text=${r.title.replace(/ /g, '+')}`;

                return `
                <div class="group relative ${cardClass} border rounded-xl overflow-hidden transition-all duration-300">
                    <div class="aspect-[16/10] relative overflow-hidden bg-black">
                        <img src="${posterUrl}"
                             onerror="this.src='https://placehold.co/600x900/1a1a1a/666?text=Error'"
                             class="w-full h-full object-cover opacity-80 group-hover:opacity-100 group-hover:scale-105 transition-all duration-700">

                        <div class="absolute inset-0 bg-gradient-to-t from-neutral-950 via-transparent to-transparent"></div>

                        <div class="absolute top-3 right-3">
                            ${getScoreRing(parseFloat(r.predicted_score))}
                        </div>

                        ${isDiscovery ? `
                            <div class="absolute top-3 left-3 px-2 py-1 text-[8px] font-bold tracking-widest uppercase border border-violet-500/50 bg-violet-900/80 text-violet-200 rounded backdrop-blur-md">
                                DISCOVERY
                            </div>
                        ` : ''}
                    </div>

                    <div class="p-5">
                        <div class="text-[9px] font-bold tracking-widest uppercase text-neutral-500 mb-2">${r.genre}</div>
                        <h3 class="text-md font-bold text-white leading-tight mb-4 group-hover:text-indigo-300 transition-colors line-clamp-2">${r.title}</h3>

                        <div class="flex items-center justify-between pt-4 border-t border-white/5">
                             <div class="text-[9px] font-mono text-neutral-600">CONFIDENCE: ${(Math.random() * (99 - 85) + 85).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

        } catch (err) {
            console.error(err);
            list.innerHTML = '<div class="col-span-full text-center text-red-500 text-xs font-mono">SYSTEM ERROR: CONNECTION LOST</div>';
        }
    }
</script>
{% endblock %}
